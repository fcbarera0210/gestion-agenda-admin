<div class="space-y-8">
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">{{ viewDate | viewDateFormat:view }}</h1>
    <div class="hidden md:flex items-center space-x-2">
      <button (click)="previousWeek()" class="p-2 text-gray-500 dark:text-gray-300 rounded-md bg-transparent hover:bg-gray-100 dark:hover:!bg-gray-700" title="Semana anterior">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
      </button>
      <button (click)="today()" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 dark:text-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600">
        Hoy
      </button>
      <button (click)="nextWeek()" class="p-2 text-gray-500 dark:text-gray-300 rounded-md bg-transparent hover:bg-gray-100 dark:hover:!bg-gray-700" title="Semana siguiente">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
      </button>
      <div class="flex items-center space-x-1 ml-2">
        <button
          (click)="setView(CalendarView.Day)"
          class="px-3 py-2 rounded-md text-sm"
          [ngClass]="view === CalendarView.Day ? 'bg-primary text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'"
        >
          Día
        </button>
        <button
          (click)="setView(CalendarView.Week)"
          class="px-3 py-2 rounded-md text-sm"
          [ngClass]="view === CalendarView.Week ? 'bg-primary text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'"
        >
          Semana
        </button>
        <button
          (click)="setView(CalendarView.Month)"
          class="px-3 py-2 rounded-md text-sm"
          [ngClass]="view === CalendarView.Month ? 'bg-primary text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200'"
        >
          Mes
        </button>
      </div>
      <div class="monthly-counts ml-4">
        <span class="count-badge" [ngStyle]="{ 'background-color': statusColors.confirmed.primary }">
          Completas: {{ monthlyCounts.confirmed }}
        </span>
        <span class="count-badge" [ngStyle]="{ 'background-color': statusColors.pending.primary }">
          Pendientes: {{ monthlyCounts.pending }}
        </span>
        <span class="count-badge" [ngStyle]="{ 'background-color': statusColors.cancelled.primary }">
          Canceladas: {{ monthlyCounts.cancelled }}
        </span>
      </div>
    </div>
  </div>

  <div>
    <div class="md:hidden flex justify-between w-full mb-4">
      <button (click)="previousWeek()" class="p-2 text-gray-500 dark:text-gray-300 rounded-md bg-white shadow hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600" title="Día anterior">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
      </button>
      <button (click)="today()" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white shadow rounded-md hover:bg-gray-100 dark:text-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600">
        Hoy
      </button>
      <button (click)="nextWeek()" class="p-2 text-gray-500 dark:text-gray-300 rounded-md bg-white shadow hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600" title="Día siguiente">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
      </button>
    </div>
    <div class="md:hidden flex justify-center mb-4 space-x-2">
      <button
        (click)="setView(CalendarView.Day)"
        class="px-3 py-2 rounded-md text-sm"
        [ngClass]="view === CalendarView.Day ? 'bg-primary text-white' : 'bg-white shadow text-gray-700 dark:text-gray-200 dark:bg-gray-700'"
      >
        Día
      </button>
      <button
        (click)="setView(CalendarView.Week)"
        class="px-3 py-2 rounded-md text-sm"
        [ngClass]="view === CalendarView.Week ? 'bg-primary text-white' : 'bg-white shadow text-gray-700 dark:text-gray-200 dark:bg-gray-700'"
      >
        Semana
      </button>
      <button
        (click)="setView(CalendarView.Month)"
        class="px-3 py-2 rounded-md text-sm"
        [ngClass]="view === CalendarView.Month ? 'bg-primary text-white' : 'bg-white shadow text-gray-700 dark:text-gray-200 dark:bg-gray-700'"
      >
        Mes
      </button>
    </div>

      <div class="p-4 md:p-8 bg-white rounded-lg shadow">
        <div class="flex items-center justify-between mb-4">
          <p class="text-gray-600 font-medium">{{ viewDate | viewDateFormat:view }}</p>
          <input
            type="date"
            class="p-2 border border-gray-300 rounded-md"
            [ngModel]="viewDate | date:'yyyy-MM-dd'"
            (ngModelChange)="onDateChange($event)"
          />
        </div>
      <div class="h-[60vh] md:h-[70vh] overflow-y-auto" *ngIf="isCalendarReady" [ngSwitch]="view">
        <mwl-calendar-day-view
          *ngSwitchCase="CalendarView.Day"
          [viewDate]="viewDate"
          [events]="events"
          [hourSegments]="2"
          [dayStartHour]="dayStartHour"
          [dayEndHour]="dayEndHour"
          (hourSegmentClicked)="onHourSegmentClicked($event)"
          (eventClicked)="handleEventClicked($event)">
        </mwl-calendar-day-view>

        <mwl-calendar-week-view
          *ngSwitchCase="CalendarView.Week"
          [viewDate]="viewDate"
          [events]="events"
          [weekStartsOn]="1"
          [locale]="locale"
          [hourSegments]="2"
          [dayStartHour]="dayStartHour"
          [dayEndHour]="dayEndHour"
          [excludeDays]="excludeDays"
          (hourSegmentClicked)="onHourSegmentClicked($event)"
          (eventClicked)="handleEventClicked($event)">
        </mwl-calendar-week-view>

        <mwl-calendar-month-view
          *ngSwitchCase="CalendarView.Month"
          [viewDate]="viewDate"
          [events]="events"
          [weekStartsOn]="1"
          [locale]="locale"
          [excludeDays]="excludeDays"
          (dayClicked)="openDayAppointmentsModal($event.day.date)"
          (eventClicked)="handleEventClicked($event)">
        </mwl-calendar-month-view>
      </div>
    </div>
    <div class="status-legend">
      <div class="status-legend-item" *ngFor="let item of statusLegend">
        <span class="status-legend-color" [style.background-color]="item.color.primary"></span>
        <span>{{ item.label }}</span>
      </div>
    </div>
  </div>
</div>

<app-appointment-form
  *ngIf="showAppointmentModal"
  [startDate]="selectedDate!"
  [appointment]="selectedAppointment"  
  [isDeleting]="isDeletingAppointment" (onSave)="handleSaveAppointment($event)"
  (onDelete)="handleDeleteAppointment($event)" 
  (onCancel)="closeAllModals()"> </app-appointment-form>

<div *ngIf="showChoiceModal" (click)="closeAllModals()" class="fixed inset-0 z-40 bg-black bg-opacity-50"></div>
<div *ngIf="showChoiceModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="relative w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg space-y-6">
    <button
      (click)="closeAllModals()"
      class="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
      aria-label="Cerrar"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <h2 class="text-2xl font-bold text-center text-gray-800">¿Qué deseas hacer?</h2>
    <div class="flex flex-col space-y-4">
      <button (click)="openAppointmentForm()" class="px-6 py-3 font-semibold text-white rounded-lg shadow-md bg-primary hover:bg-opacity-90">
        Agendar Nueva Cita
      </button>
      <button (click)="openTimeBlockForm()" class="px-6 py-3 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:text-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600">
        Bloquear este Horario
      </button>
    </div>
  </div>
</div>

<app-time-block-form
  *ngIf="showTimeBlockModal"
  [startDate]="selectedDate!"
  [timeBlock]="selectedTimeBlock"
  [isDeleting]="isDeletingBlock" (onSave)="handleSaveTimeBlock($event)"
  (onDelete)="handleDeleteTimeBlock($event)"
  (onCancel)="closeAllModals()">
</app-time-block-form>

<app-day-appointments-modal
  *ngIf="showDayAppointmentsModal"
  [date]="selectedDate!"
  [events]="dayAppointments"
  (onClose)="closeAllModals()"
></app-day-appointments-modal>

