<div class="space-y-8">
  <div
    class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4"
  >
    <div>
      <h1 class="text-3xl font-bold text-secondary">Dashboard</h1>
      <p class="mt-1 text-neutral-600">
        Bienvenido, aquí tienes un resumen de tu actividad.
      </p>
    </div>
    <div class="flex items-center space-x-2">
      <app-ui-button (click)="openNewBlockModal()">Bloquear Horario</app-ui-button>
      <app-ui-button (click)="openNewAppointmentModal()">+ Agendar Cita</app-ui-button>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
    <div
      class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-between cursor-pointer transition-shadow hover:shadow-xl"
      (click)="selectView('day')"
      [ngClass]="{
        'ring-2 ring-white/70':
          activeView !== 'pending' && activeView !== 'cancelled',
      }"
    >
      <div>
        <span class="text-sm font-medium">Citas para Hoy</span>
        <p class="text-3xl font-bold">
          {{ (upcomingAppointments$ | async)?.length || 0 }}
        </p>
      </div>
      <div class="p-3 rounded-full bg-white/20 text-white">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
          ></path>
        </svg>
      </div>
    </div>
    <div
      class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-between cursor-pointer aspect-square transition-shadow hover:shadow-xl"
      (click)="selectView('pending')"
      [ngClass]="{
        'ring-2 ring-white/70': activeView === 'pending',
      }"
    >
      <div>
        <span class="text-sm font-medium">Citas Pendientes</span>
        <p class="text-3xl font-bold">
          {{ (pendingMonthAppointments$ | async)?.length || 0 }}
        </p>
      </div>
      <div class="p-3 rounded-full bg-white/20 text-white">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
      </div>
    </div>
    <div
      class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-between cursor-pointer aspect-square transition-shadow hover:shadow-xl"
      (click)="selectView('cancelled')"
      [ngClass]="{
        'ring-2 ring-white/70': activeView === 'cancelled',
      }"
    >
      <div>
        <span class="text-sm font-medium">Citas Canceladas</span>
        <p class="text-3xl font-bold">
          {{ cancelledAppointments.length }}
        </p>
      </div>
      <div class="p-3 rounded-full bg-white/20 text-white">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
      </div>
    </div>
    <div
      class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-between cursor-pointer transition-shadow hover:shadow-xl"
      routerLink="/clients"
    >
      <div>
        <span class="text-sm font-medium">Total de Clientes</span>
        <p class="text-3xl font-bold">{{ stats.totalClients }}</p>
      </div>
      <div class="p-3 rounded-full bg-white/20 text-white">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
          ></path>
        </svg>
      </div>
    </div>
    <div
      class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-between cursor-pointer transition-shadow hover:shadow-xl"
      routerLink="/services"
    >
      <div>
        <span class="text-sm font-medium">Servicios Ofrecidos</span>
        <p class="text-3xl font-bold">
          {{ stats.totalServices }}
        </p>
      </div>
      <div class="p-3 rounded-full bg-white/20 text-white">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"
          ></path>
        </svg>
      </div>
    </div>
  </div>

  <div class="p-6 rounded-2xl shadow-lg bg-gradient-to-br from-neutral-50 to-neutral-100 hover:shadow-xl">
    <div class="flex items-center border-b mb-4">
      <div
        class="flex space-x-4"
        *ngIf="activeView !== 'pending' && activeView !== 'cancelled'"
      >
        <button
          (click)="selectView('day')"
          class="pb-2"
          [ngClass]="{
            'border-b-2 border-primary text-primary': activeView === 'day',
          }"
        >
          Hoy
        </button>
        <button
          (click)="selectView('week')"
          class="pb-2"
          [ngClass]="{
            'border-b-2 border-primary text-primary': activeView === 'week',
          }"
        >
          Semana
        </button>
        <button
          (click)="selectView('month')"
          class="pb-2"
          [ngClass]="{
            'border-b-2 border-primary text-primary': activeView === 'month',
          }"
        >
          Mes
        </button>
      </div>
        <div class="ml-auto text-sm text-neutral-600">
        <ng-container [ngSwitch]="activeView">
          <span *ngSwitchCase="'day'"
            >{{ (upcomingAppointments$ | async)?.length || 0 }} citas</span
          >
          <span *ngSwitchCase="'week'"
            >{{ (weekAppointments$ | async)?.length || 0 }} citas</span
          >
          <span *ngSwitchCase="'month'"
            >{{ (monthAppointments$ | async)?.length || 0 }} citas</span
          >
          <span *ngSwitchCase="'pending'"
            >{{ (pendingMonthAppointments$ | async)?.length || 0 }} citas</span
          >
          <span *ngSwitchCase="'cancelled'"
            >{{ cancelledAppointments.length }} citas</span
          >
        </ng-container>
      </div>
    </div>
    <div class="mt-4">
      <ng-container *ngIf="activeView === 'day'">
        <ng-container
          *ngIf="upcomingAppointments$ | async as appointments; else loading"
        >
          <div *ngIf="appointments.length > 0; else emptyDay" class="space-y-4">
            <div
              *ngFor="let apt of appointments"
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border rounded-lg gap-2 cursor-pointer hover:bg-neutral-50"
              (click)="openEditAppointment(apt)"
            >
              <div
                class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0"
              >
                <div class="text-center sm:text-left">
                  <p class="font-bold text-primary">
                    {{
                      apt.start.toDate() | date: "EEE dd/MM" : undefined : "es"
                    }}
                  </p>
                  <p class="text-xs text-neutral-500">
                    {{
                      apt.start.toDate() | date: "shortTime" : undefined : "es"
                    }}
                    -
                    {{
                      apt.end.toDate() | date: "shortTime" : undefined : "es"
                    }}
                  </p>
                </div>
                <div class="text-center sm:text-left">
                  <h3 class="font-semibold text-neutral-800">{{ apt.title }}</h3>
                  <p class="text-sm text-neutral-500">
                    {{ clientsMap.get(apt.clientId) || "Cliente Desconocido" }}
                  </p>
                </div>
              </div>
              <div
                class="self-start sm:self-auto sm:ml-auto flex items-center gap-2"
              >
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="apt.type === 'online' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'"
                >
                  {{ getTypeLabel(apt.type) }}
                </span>
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="{
                    'bg-blue-100 text-blue-800': apt.status === 'confirmed',
                    'bg-yellow-100 text-yellow-800': apt.status === 'pending',
                    'bg-red-100 text-red-800': apt.status === 'cancelled',
                  }"
                >
                  {{ getStatusLabel(apt.status) }}
                </span>
              </div>
            </div>
          </div>
          <ng-template #emptyDay
            ><p class="text-center text-neutral-500">
              No tienes citas programadas para hoy.
            </p></ng-template
          >
        </ng-container>
      </ng-container>

      <ng-container *ngIf="activeView === 'week'">
        <ng-container
          *ngIf="weekAppointments$ | async as appointments; else loading"
        >
          <div
            *ngIf="appointments.length > 0; else emptyWeek"
            class="space-y-4"
          >
            <div
              *ngFor="let apt of appointments"
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border rounded-lg gap-2 cursor-pointer hover:bg-neutral-50"
              (click)="openEditAppointment(apt)"
            >
              <div
                class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0"
              >
                <div class="text-center sm:text-left">
                  <p class="font-bold text-primary">
                    {{
                      apt.start.toDate() | date: "EEE dd/MM" : undefined : "es"
                    }}
                  </p>
                  <p class="text-xs text-neutral-500">
                    {{
                      apt.start.toDate() | date: "shortTime" : undefined : "es"
                    }}
                    -
                    {{
                      apt.end.toDate() | date: "shortTime" : undefined : "es"
                    }}
                  </p>
                </div>
                <div class="text-center sm:text-left">
                  <h3 class="font-semibold text-neutral-800">{{ apt.title }}</h3>
                  <p class="text-sm text-neutral-500">
                    {{ clientsMap.get(apt.clientId) || "Cliente Desconocido" }}
                  </p>
                </div>
              </div>
              <div
                class="self-start sm:self-auto sm:ml-auto flex items-center gap-2"
              >
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="apt.type === 'online' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'"
                >
                  {{ getTypeLabel(apt.type) }}
                </span>
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="{
                    'bg-blue-100 text-blue-800': apt.status === 'confirmed',
                    'bg-yellow-100 text-yellow-800': apt.status === 'pending',
                    'bg-red-100 text-red-800': apt.status === 'cancelled',
                  }"
                >
                  {{ getStatusLabel(apt.status) }}
                </span>
              </div>
            </div>
          </div>
          <ng-template #emptyWeek
            ><p class="text-center text-neutral-500">
              No tienes citas programadas esta semana.
            </p></ng-template
          >
        </ng-container>
      </ng-container>

      <ng-container *ngIf="activeView === 'month'">
        <ng-container
          *ngIf="monthAppointments$ | async as appointments; else loading"
        >
          <div
            *ngIf="appointments.length > 0; else emptyMonth"
            class="space-y-4"
          >
            <div
              *ngFor="let apt of appointments"
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border rounded-lg gap-2 cursor-pointer hover:bg-neutral-50"
              (click)="openEditAppointment(apt)"
            >
              <div
                class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0"
              >
                <div class="text-center sm:text-left">
                  <p class="font-bold text-primary">
                    {{
                      apt.start.toDate() | date: "EEE dd/MM" : undefined : "es"
                    }}
                  </p>
                  <p class="text-xs text-neutral-500">
                    {{
                      apt.start.toDate() | date: "shortTime" : undefined : "es"
                    }}
                    -
                    {{
                      apt.end.toDate() | date: "shortTime" : undefined : "es"
                    }}
                  </p>
                </div>
                <div class="text-center sm:text-left">
                  <h3 class="font-semibold text-neutral-800">{{ apt.title }}</h3>
                  <p class="text-sm text-neutral-500">
                    {{ clientsMap.get(apt.clientId) || "Cliente Desconocido" }}
                  </p>
                </div>
              </div>
              <div
                class="self-start sm:self-auto sm:ml-auto flex items-center gap-2"
              >
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="apt.type === 'online' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'"
                >
                  {{ getTypeLabel(apt.type) }}
                </span>
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="{
                    'bg-blue-100 text-blue-800': apt.status === 'confirmed',
                    'bg-yellow-100 text-yellow-800': apt.status === 'pending',
                    'bg-red-100 text-red-800': apt.status === 'cancelled',
                  }"
                >
                  {{ getStatusLabel(apt.status) }}
                </span>
              </div>
            </div>
          </div>
          <ng-template #emptyMonth
            ><p class="text-center text-neutral-500">
              No tienes citas programadas este mes.
            </p></ng-template
          >
        </ng-container>
      </ng-container>

      <ng-container *ngIf="activeView === 'pending'">
        <ng-container
          *ngIf="
            pendingMonthAppointments$ | async as appointments;
            else loading
          "
        >
          <div
            *ngIf="appointments.length > 0; else emptyPending"
            class="space-y-4"
          >
            <div
              *ngFor="let apt of appointments"
              class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border rounded-lg gap-2 cursor-pointer hover:bg-neutral-50"
              (click)="openEditAppointment(apt)"
            >
              <div
                class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0"
              >
                <div class="text-center sm:text-left">
                  <p class="font-bold text-primary">
                    {{
                      apt.start.toDate() | date: "EEE dd/MM" : undefined : "es"
                    }}
                  </p>
                  <p class="text-xs text-neutral-500">
                    {{
                      apt.start.toDate() | date: "shortTime" : undefined : "es"
                    }}
                    -
                    {{
                      apt.end.toDate() | date: "shortTime" : undefined : "es"
                    }}
                  </p>
                </div>
                <div class="text-center sm:text-left">
                  <h3 class="font-semibold text-neutral-800">{{ apt.title }}</h3>
                  <p class="text-sm text-neutral-500">
                    {{ clientsMap.get(apt.clientId) || "Cliente Desconocido" }}
                  </p>
                </div>
              </div>
              <div
                class="self-start sm:self-auto sm:ml-auto flex items-center gap-2"
              >
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full"
                  [ngClass]="apt.type === 'online' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'"
                >
                  {{ getTypeLabel(apt.type) }}
                </span>
                <span
                  class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800"
                  >Pendiente</span
                >
              </div>
            </div>
          </div>
        <ng-template #emptyPending
          ><p class="text-center text-neutral-500">
            No tienes citas pendientes este mes.
          </p></ng-template
        >
        </ng-container>
      </ng-container>

      <ng-container *ngIf="activeView === 'cancelled'">
        <div
          *ngIf="cancelledAppointments.length > 0; else emptyCancelled"
          class="space-y-4"
        >
          <div
            *ngFor="let apt of cancelledAppointments"
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 border rounded-lg gap-2 cursor-pointer hover:bg-neutral-50"
            (click)="openEditAppointment(apt)"
          >
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-2 sm:space-y-0"
            >
              <div class="text-center sm:text-left">
                <p class="font-bold text-primary">
                  {{ apt.start.toDate() | date: "EEE dd/MM" : undefined : "es" }}
                </p>
                <p class="text-xs text-neutral-500">
                  {{ apt.start.toDate() | date: "shortTime" : undefined : "es" }}
                  -
                  {{ apt.end.toDate() | date: "shortTime" : undefined : "es" }}
                </p>
              </div>
              <div class="text-center sm:text-left">
                <h3 class="font-semibold text-neutral-800">{{ apt.title }}</h3>
                <p class="text-sm text-neutral-500">
                  {{ clientsMap.get(apt.clientId) || "Cliente Desconocido" }}
                </p>
              </div>
            </div>
            <div
              class="self-start sm:self-auto sm:ml-auto flex items-center gap-2"
            >
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full"
                [ngClass]="apt.type === 'online' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'"
              >
                {{ getTypeLabel(apt.type) }}
              </span>
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"
                >Cancelada</span
              >
            </div>
          </div>
        </div>
        <ng-template #emptyCancelled>
          <p class="text-center text-neutral-500">
            No tienes citas canceladas próximas.
          </p>
        </ng-template>
      </ng-container>

      <ng-template #loading
        ><p class="text-neutral-500">Cargando citas...</p></ng-template
      >
    </div>
  </div>
</div>

<app-appointment-form
  *ngIf="showAppointmentModal"
  [startDate]="selectedDate!"
  [appointment]="selectedAppointment"
  (onSave)="handleSaveAppointment($event)"
  (onCancel)="closeAllModals()"
>
</app-appointment-form>

<app-appointment-details-modal
  *ngIf="showAppointmentDetailsModal"
  [appointment]="selectedAppointment!"
  (onSave)="handleSaveAppointment($event)"
  (onCancel)="closeAllModals()"
></app-appointment-details-modal>

<app-time-block-form
  *ngIf="showTimeBlockModal"
  [startDate]="selectedDate!"
  [timeBlock]="null"
  [onSave]="handleSaveTimeBlock.bind(this)"
  (onCancel)="closeAllModals()"
>
</app-time-block-form>
